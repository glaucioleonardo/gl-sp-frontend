var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{SpCore}from"../setup/core-services-setup.service";import{AttachmentIcon}from"gl-w-frontend";import{sp}from"@pnp/sp/presets/core";import"@pnp/sp/attachments";class Core{fieldsToStringArray(fields){return fields.toString().replace("[","").replace("]","")}retrieve(listName,fieldsArray=[],baseUrl){return __awaiter(this,void 0,void 0,(function*(){const fields=this.fieldsToStringArray(fieldsArray);const base=baseUrl==null?SpCore.baseUrl:baseUrl;try{return yield sp.configure(SpCore.config,base).web.lists.getByTitle(listName).items.select(fields).getAll()}catch(reason){const error=SpCore.onError(reason);SpCore.showErrorLog(reason);throw new Error(error.code.toString())}}))}retrieveSingle(listItemId,listName,fieldsArray=[],baseUrl){return __awaiter(this,void 0,void 0,(function*(){const fields=this.fieldsToStringArray(fieldsArray);const base=baseUrl==null?SpCore.baseUrl:baseUrl;try{return yield sp.configure(SpCore.config,base).web.lists.getByTitle(listName).items.getById(listItemId).select(fields).get()}catch(reason){const error=SpCore.onError(reason);SpCore.showErrorLog(reason);throw new Error(error.code.toString())}}))}recycle(listItemId,listName,baseUrl){const base=baseUrl==null?SpCore.baseUrl:baseUrl;return new Promise((resolve,reject)=>{sp.configure(SpCore.config,base).web.lists.getByTitle(listName).items.getById(listItemId).recycle().then(()=>{resolve({code:200,description:"Success!",message:"The item has been moved to recycle bin."})}).catch(reason=>{const error=SpCore.showErrorLog(reason);reject(error)})})}delete(listItemId,listName,baseUrl){const base=baseUrl==null?SpCore.baseUrl:baseUrl;return new Promise((resolve,reject)=>{sp.configure(SpCore.config,base).web.lists.getByTitle(listName).items.getById(listItemId).delete().then(()=>{resolve({code:200,description:"Success!",message:"The item has been deleted successfully."})}).catch(reason=>{const error=SpCore.showErrorLog(reason);reject(error)})})}add(listName,data,baseUrl){const base=baseUrl==null?SpCore.baseUrl:baseUrl;return new Promise((resolve,reject)=>{sp.configure(SpCore.config,base).web.lists.getByTitle(listName).items.add(data).then(iar=>{resolve(iar)}).catch(reason=>{const error=SpCore.showErrorLog(reason);reject(error)})})}update(listItemId,listName,data,baseUrl){const base=baseUrl==null?SpCore.baseUrl:baseUrl;return new Promise((resolve,reject)=>{sp.configure(SpCore.config,base).web.lists.getByTitle(listName).items.getById(listItemId).update(data).then(iar=>{resolve(iar)}).catch(reason=>{const error=SpCore.showErrorLog(reason);reject(error)})})}}export const ListItemsCore=new Core;class Attachment{add(listItemId,listName,attachments,baseUrl){const base=baseUrl==null?SpCore.baseUrl:baseUrl;return new Promise((resolve,reject)=>{sp.configure(SpCore.config,base).web.lists.getByTitle(listName).items.getById(listItemId).attachmentFiles.addMultiple(attachments).then(()=>{resolve({code:200,description:"Success!",message:"The attachments has been added successfully."})}).catch(reason=>{SpCore.showErrorLog(reason);reject([])})})}delete(listItemId,listName,attachments,baseUrl){const base=baseUrl==null?SpCore.baseUrl:baseUrl;return new Promise((resolve,reject)=>{sp.configure(SpCore.config,base).web.lists.getByTitle(listName).items.getById(listItemId).attachmentFiles.deleteMultiple(...attachments).then(()=>{resolve({code:200,description:"Success!",message:"The attachments has been deleted successfully."})}).catch(reason=>{SpCore.showErrorLog(reason);reject([])})})}retrieve(listItemId,listName,baseUrl){const base=baseUrl==null?SpCore.baseUrl:baseUrl;return new Promise((resolve,reject)=>{sp.configure(SpCore.config,base).web.lists.getByTitle(listName).items.getById(listItemId).attachmentFiles.get().then(attachments=>{resolve(attachments)}).catch(reason=>{SpCore.showErrorLog(reason);reject([])})})}retrieveForBinding(listItemId,listName,baseUrl){return __awaiter(this,void 0,void 0,(function*(){let base=baseUrl==null?SpCore.baseUrl:baseUrl;if(!base.includes("http")){base="http://"+base}const attachmentList=yield this.retrieve(listItemId,listName,base);const attachments=[];for(const attachment of attachmentList){const host=base.split("://")[0]+"://"+base.split("://")[1].split("/")[0];const serverRelativeUrl=attachment.ServerRelativeUrl;const url=encodeURI(host+serverRelativeUrl);const file={id:attachmentList.length,new:false,remove:false,name:attachment.FileName,url:url,icon:AttachmentIcon.get(attachment.FileName)};attachments.push(file)}return attachments}))}retrieveTxtContent(listItemId,listName,fileName="attachment",baseUrl){const base=baseUrl==null?SpCore.baseUrl:baseUrl;return new Promise((resolve,reject)=>{sp.configure(SpCore.config,base).web.lists.getByTitle(listName).items.getById(listItemId).attachmentFiles.getByName(`${fileName}.txt`).getText().then(image=>{resolve(image)}).catch(reason=>{SpCore.showErrorLog(reason);reject("")})})}setTxtContent(listItemId,listName,fileName="attachment",content,baseUrl){const base=baseUrl==null?SpCore.baseUrl:baseUrl;return new Promise((resolve,reject)=>{sp.configure(SpCore.config,base).web.lists.getByTitle(listName).items.getById(listItemId).attachmentFiles.getByName(`${fileName}.txt`).setContent(content).then(attachmentFile=>{resolve(attachmentFile)}).catch(reason=>{const error=SpCore.showErrorLog(reason);reject(error)})})}addTxtContent(listItemId,listName,fileName="attachment",content,baseUrl){const base=baseUrl==null?SpCore.baseUrl:baseUrl;return new Promise((resolve,reject)=>{sp.configure(SpCore.config,base).web.lists.getByTitle(listName).items.getById(listItemId).attachmentFiles.add(`${fileName}.txt`,content).then(attachmentFile=>{resolve(attachmentFile)}).catch(reason=>{const error=SpCore.showErrorLog(reason);reject(error)})})}}export const ListItemsAttachment=new Attachment;class Search{retrieveSearch(listName,fieldsArray=[],filter="",orderBy="ID",ascending=true,baseUrl){const base=baseUrl==null?SpCore.baseUrl:baseUrl;const fields=fieldsArray.toString().replace("[","").replace("]","");return new Promise((resolve,reject)=>__awaiter(this,void 0,void 0,(function*(){sp.configure(SpCore.config,base).web.lists.getByTitle(listName).items.orderBy(orderBy,ascending).select(fields).filter(filter).getAll().then(result=>{resolve(result)}).catch(reason=>{SpCore.showErrorLog(reason);reject(reason)})})))}}export const ListItemsSearch=new Search;